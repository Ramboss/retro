// Заголовок 192x22
// Мелодия
// Меню

#include <mem.h>
#include <apogey/bios.h>
#include "music.h"
#include "credits.h"
#include "stdlib.h"
#include "screen.h"
#include "n.h"
#include "game.h"
#include "interface.h"

// Все уровни игры

uchar all[1] = {
// level 1 hi
255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,1,255,255,255,255,255,255,255,255,255,255,255,255,
255,255,255,255,255,255,255,255,255,255,255,255,33,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,
// level 2 hi3
255,255,255,255,255,255,255,255,255,255,255,255,4,255,255,255,255,1,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,
255,255,255,255,255,255,255,36,255,255,255,255,255,255,255,255,255,255,255,255,255,255,1,255,255,255,255,255,255,255,255,255,255,255,255,
// level 3 order2
255,255,255,255,255,255,255,255,255,255,255,4,1,255,255,255,8,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,
255,255,255,255,255,255,255,255,255,255,17,255,255,255,255,255,255,255,56,255,255,4,255,255,255,255,255,255,255,255,255,255,255,255,255,
// level 4 push
255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,1,255,255,255,255,255,255,255,255,255,255,255,4,255,255,255,255,255,255,255,
255,255,36,255,255,255,255,255,255,255,255,255,255,255,49,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,
// level 5 stairs
255,255,255,255,255,255,255,255,255,255,255,1,255,255,255,255,255,8,255,255,255,255,255,4,255,255,255,255,255,255,255,255,255,255,255,
255,255,255,255,255,255,33,255,255,255,20,255,40,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,
// level 6 stairs2
255,255,255,255,255,255,255,255,255,255,255,1,255,255,255,255,255,4,255,255,255,255,255,8,255,255,255,255,255,255,255,255,255,255,255,
255,255,255,255,255,255,33,255,255,255,20,255,40,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,
// level 7 lift
255,255,255,255,255,8,255,255,255,255,255,4,255,255,255,255,255,255,255,255,255,255,1,255,255,255,255,255,255,255,255,255,255,255,255,
255,255,255,255,255,255,255,255,33,255,255,255,255,255,52,255,255,8,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,
// level 8 presq
255,255,255,255,255,255,255,255,255,255,255,255,255,4,255,255,255,255,255,255,255,17,255,16,255,255,255,255,255,255,255,255,255,255,255,
255,255,255,255,255,255,255,255,255,255,255,36,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,
// level 9 sq
255,255,255,255,255,255,255,255,255,255,255,255,9,8,255,255,255,255,255,255,17,255,16,255,255,255,255,255,255,255,255,255,255,255,255,
255,255,255,255,255,255,255,255,255,255,41,255,255,255,255,255,255,255,255,255,8,255,255,255,255,255,255,255,255,255,255,255,255,255,255,
// level 10 nobrainer
255,255,255,255,255,255,255,255,255,255,255,9,4,255,255,17,255,16,19,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,
255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,9,255,4,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,
// level 11 crosst
255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,8,1,17,4,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,
255,255,255,255,255,255,255,33,255,255,255,255,255,255,255,255,255,255,255,52,255,255,255,255,255,255,255,8,255,255,255,255,255,255,255,
// level 12 t
255,255,255,255,255,255,255,18,255,255,255,255,255,255,255,255,1,4,8,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,
255,255,255,255,255,17,255,255,255,52,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,8,255,255,255,255,255,255,255,
// level 13 rotation
255,255,255,255,255,255,18,255,255,255,255,8,255,19,255,255,9,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,
255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,25,255,255,255,255,255,255,8,255,255,255,255,255,255,255,255,255,255,255,255,
// level 14 asymm
255,8,255,255,255,255,18,255,255,255,255,4,255,255,255,255,255,255,255,255,9,255,255,255,255,255,255,255,255,255,255,255,255,255,255,
255,255,255,255,255,255,8,255,255,255,255,255,255,255,255,255,255,255,57,255,255,255,255,255,255,255,255,4,255,255,255,255,255,255,255,
// level 15 clover
255,255,255,255,255,255,255,255,255,255,255,1,255,9,255,255,255,4,255,255,255,255,255,8,255,255,255,255,255,255,255,255,255,255,255,
255,255,255,255,255,255,255,255,255,255,255,255,40,255,255,255,25,255,49,255,255,255,4,255,255,255,255,255,255,255,255,255,255,255,255,
// level 16 preduced
255,255,255,255,255,255,255,255,255,255,18,255,255,19,255,17,1,255,255,255,255,4,255,255,255,255,255,255,255,255,255,255,255,255,255,
255,255,255,255,255,255,255,255,255,255,1,255,255,255,255,255,255,255,255,255,255,255,4,255,255,255,255,255,255,255,255,255,255,255,255,
// level 17 herewego
255,255,255,255,255,255,255,255,255,255,17,255,18,255,255,1,255,19,4,255,255,16,255,255,255,255,255,255,255,255,255,255,255,255,255,
255,255,255,255,255,255,255,255,255,255,1,255,255,255,255,255,255,4,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,
// level 18 reduced
255,255,255,255,255,255,255,255,255,255,18,255,255,19,255,17,1,8,4,255,255,255,16,255,255,255,255,255,255,255,255,255,255,255,255,
255,255,255,255,255,255,255,255,255,255,1,255,255,4,255,8,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,
// level 19 reduced2
255,255,255,255,255,255,255,255,255,255,18,255,255,19,255,17,1,8,4,255,255,255,16,255,255,255,255,255,255,255,255,255,255,255,255,
255,255,255,255,255,255,255,255,255,255,8,255,255,4,255,1,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,
// level 20 spiral2
255,255,1,255,255,255,255,255,255,255,255,255,4,255,255,18,255,255,255,255,255,18,8,19,255,255,17,16,255,255,17,255,255,16,255,
255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,1,255,255,255,255,255,4,255,255,255,255,255,8,255,255,255,255,255,255,255,
// level 21 recycle2
255,255,255,255,255,255,18,12,19,255,255,8,255,4,255,255,17,5,16,255,255,255,255,255,255,255,16,255,255,255,255,255,255,255,255,
255,255,255,255,255,255,8,255,5,255,255,255,255,255,255,255,12,255,4,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,
// level 22 recycle3
255,255,255,255,255,255,18,255,19,255,255,8,255,1,255,255,16,255,4,255,255,18,255,9,255,255,17,255,16,255,255,255,255,255,255,
255,255,255,255,255,255,8,255,9,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,1,255,4,255,255,255,255,255,255,
// level 23 shirt
255,255,255,255,255,255,18,1,255,255,255,255,255,255,255,17,255,255,255,255,255,255,255,255,19,255,16,255,255,255,255,255,255,255,255,
255,255,255,255,255,255,4,255,255,255,255,255,255,255,40,1,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,
// level 24 shuttle
255,255,255,255,255,255,255,18,255,255,255,255,255,255,19,17,255,255,255,255,255,1,4,8,255,255,255,16,255,255,255,255,255,255,255,
255,255,255,255,255,255,36,255,255,255,255,255,255,255,1,8,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,
// level 25 spiral
1,255,255,255,255,255,4,255,255,255,18,255,8,255,255,255,18,255,19,255,255,17,16,255,255,17,255,255,16,255,255,255,255,255,255,
255,255,255,255,255,255,255,255,255,255,1,255,255,255,255,255,4,255,255,255,255,255,8,255,255,255,255,255,255,255,255,255,255,255,255,
// level 26 splinter
255,255,255,255,255,1,4,8,255,255,18,255,255,19,255,255,255,255,255,255,17,255,16,255,255,255,255,255,255,255,255,255,255,255,255,
255,255,255,255,255,255,255,255,255,255,4,255,255,255,255,255,255,255,255,255,8,255,1,255,255,255,255,255,255,255,255,255,255,255,255,
// level 27 elegant
255,255,255,255,255,255,18,9,255,255,4,255,255,19,255,17,255,255,8,255,255,1,16,255,255,255,255,255,255,255,255,255,255,255,255,
255,255,255,255,255,255,9,255,255,255,255,255,255,8,255,4,255,255,255,255,255,255,1,255,255,255,255,255,255,255,255,255,255,255,255,
// level 28 shuttle2
255,255,255,255,255,255,255,255,18,255,255,255,255,255,19,17,255,255,255,255,255,1,4,8,255,255,255,255,16,255,255,255,255,255,255,
255,255,255,255,255,255,40,255,255,255,255,255,255,255,4,1,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,
// level 29 shirt2
255,255,255,255,255,255,18,255,255,255,4,255,255,255,255,17,255,255,255,255,255,255,255,255,19,255,16,255,255,255,255,255,255,255,255,
255,255,255,255,255,255,4,255,255,255,255,255,255,255,40,1,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,
// level 30 windmill
255,255,255,255,255,255,255,18,255,255,255,255,1,255,255,255,9,255,4,19,255,255,8,255,255,255,255,16,255,255,255,255,255,255,255,
255,255,255,255,255,255,255,4,255,255,255,255,255,255,255,17,255,255,255,8,255,255,255,255,255,255,255,9,255,255,255,255,255,255,255,
// level 31 paper
255,255,255,255,255,18,8,255,19,255,4,255,255,255,255,1,255,255,255,255,17,255,16,255,255,255,255,255,255,255,255,255,255,255,255,
255,255,255,255,255,8,255,255,255,255,255,255,255,255,255,255,255,255,255,255,1,255,4,255,255,255,255,255,255,255,255,255,255,255,255,
// level 32 shuttle5
255,255,255,255,255,255,255,18,255,255,255,17,255,255,255,4,255,1,19,8,255,255,255,255,255,255,255,16,255,255,255,255,255,255,255,
255,255,255,255,255,255,255,4,255,255,255,8,255,255,255,255,255,255,1,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,
// level 33 shirtDouble
255,255,255,255,255,255,18,1,255,255,4,255,255,255,255,17,255,255,255,255,255,255,255,255,19,255,16,255,255,255,255,255,255,255,255,
255,255,255,255,255,255,4,255,255,255,255,255,255,255,40,1,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,
// level 34 splinter2
255,255,255,255,255,4,1,8,255,255,255,18,255,255,19,255,255,255,255,255,255,17,255,16,255,255,255,255,255,255,255,255,255,255,255,
255,255,255,255,255,255,255,255,255,255,255,4,255,255,255,255,255,255,255,255,255,8,255,1,255,255,255,255,255,255,255,255,255,255,255,
// level 35 reduced3
255,255,255,255,255,255,255,255,255,255,18,255,255,19,255,17,255,1,255,255,255,8,16,4,255,255,255,255,255,255,255,255,255,255,255,
255,255,255,255,255,255,255,255,255,255,8,255,255,4,255,1,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,
// level 36 elegant2
255,255,255,255,255,255,18,8,1,9,255,255,255,255,19,255,255,255,255,255,17,255,255,255,255,255,255,255,16,255,255,255,255,255,255,
255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,25,17,24,255,255,255,255,255,255,255,
};

// Ширина и высота карты
#define MAPW_ 14
#define MAPH 8

// Кол-во байт на линию в массиве MAP
#define MAPBPL 16

// Карта (размер с запасом)
uchar map1[256], map2[256];

// Координаты курсора
uchar cx, cy;

// Текущий уровень
uchar level=0;

// Загрузить уровень
void loadLevel() {
  uchar *p, *d, i;

  drawLevelNumber();

  memset(map1, 0xFF, MAPBPL*MAPH);
  memset(map2, 0xFF, MAPBPL*MAPH);
 
  p = all + level*(5*7*2);
  d = map1 + ((MAPW_-5)/2) + ((MAPH+1-7)/2)*MAPBPL;
  for(i=0; i<7; i++) {
    memcpy(d, p, 5); p += 5; d += MAPBPL;
  }
  d = map2 + ((MAPW_-5)/2) + ((MAPH+1-7)/2)*MAPBPL;
  for(i=0; i<7; i++) {
    memcpy(d, p, 5); p += 5; d += MAPBPL;
  }

  check();
  nextLevelAnim();
  redraw();
}

// Загрузить следующий уровень
void nextLevel() {
  level++;
  if(level >= 37) level=0;  
  loadLevel();
}

void move(uchar dx, uchar dy) {
  uchar n=0, x=cx, y=cy, x1, y1, px, py, pn, d;
  
  for(;;) {
    if(x>=MAPW_) return;
    if(y>=MAPH) return;
    if(map2[x+(uchar)(y*MAPBPL)] == 0xFF) break;
    n++; 	
    x+=dx, y+=dy;
  }

  if(n==0) return;


  px=x, py=y, pn=n;

  scrollAnimation1(x,y,dx,dy,px,py,pn);  

  y1 = cy+dy; x1 = cx+dx; 
  if(x1<MAPW_ && y1<MAPH) cy=y1, cx=x1;  
  
  for(;n; --n) {
    x1=x-dx, y1=y-dy;
    if(x<MAPW_ && y<MAPH)
      map2[x+(uchar)(y*MAPBPL)] = map2[x1+(uchar)(y1*MAPBPL)];
    x=x1; y=y1;
  }

  map2[x+(uchar)(y*MAPBPL)] = 0xFF;

  scrollAnimation2(x,y,dx,dy,px,py,pn);  
}

void check() {
  uchar x, y, s, s1, done, *m1, *m2;

  done = 1; 
  for(y=0, m1=map1, m2=map2; y<MAPH; y++) {
    for(x=0; x<MAPW_; x++, m1++, m2++) {
      s = *m2;
      if(s != 0xFF) {
        s1 = *m1;
        if(s1 != 0xFF && s1 >= 16) s = (uchar)(s & 15) + (uchar)((uchar)(s1 - 16) << 4), *m2 = s;
        if((s & 15) != s1) done = 0;
      }
    }
  }

  if(done) {
    nextLevel();
    return;
  }
}

void click() {
  switch((uchar)(map2[(uchar)(cx+(uchar)(cy*MAPBPL))] >> 4)) {
    case 0: move(0,-1); break;
    case 1: move(1, 0); break;
    case 2: move(0, 1); break;
    case 3: move(-1,0); break;
  }
  check();
  redraw();
}

void findNext() {
  do {
    cx++;
    if(cx==MAPW_) {
      cy++;
      if(cy==MAPH) cy=0;
      cx=0;
    }
  } while(map2[cx+(uchar)(cy*MAPBPL)] == 0xFF); 
}

void main() {   
  uchar filter=0, c, cursorDel=1;

  level=0;

  introScreen();

  prepareScreen();
  initInterface();
  loadLevel();

  cx=MAPW_/2; cy=MAPH/2;
  showCursor();
  for(;;) {
    c = bioskey();
    if(filter) filter--, c=0xFF;
    if(c==0xFF) {
      cursorDel--;
      if(cursorDel==0) { cursorDel=10; showCursor(); }
      delay(1);
      continue;
    }
    filter=10;
    switch(c) {
      case 0x1B: hideCursor(); loadLevel(); break;
      case 2:    showCredits(); prepareScreen(); drawLevelNumber(); redraw(); break;
      case 1:    hideCursor(); nextLevel(); break;
      case 0x08: if(cx==0     ) break; hideCursor(); cx--; break;
      case 0x18: if(cx==MAPW_-1) break; hideCursor(); cx++; break;
      case 0x19: if(cy==0     ) break; hideCursor(); cy--; break;
      case 0x1A: if(cy==MAPH-1) break; hideCursor(); cy++; break;
      case 0x0D: hideCursor(); findNext(); break;
      case ' ':  hideCursor(); click(); break;
    }
    showCursor();
  }
}